package com.user.service.service;

import com.user.service.entity.User;
import com.user.service.exception.NotFoundException;
import com.user.service.repository.UserRepository;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;

import reactor.core.publisher.Mono;
import reactor.test.StepVerifier;

class UserServiceTest {

	private UserRepository userRepo;
	private UserServiceImpl userService;

	@BeforeEach
	void setup() {
		userRepo = Mockito.mock(UserRepository.class);
		userService = new UserServiceImpl(userRepo);
	}

	@Test
	void testGetUserById_Success() {
		User user = new User("1", "Yati", "yati@mail.com");

		Mockito.when(userRepo.findById("1")).thenReturn(Mono.just(user));

		StepVerifier.create(userService.getUser("1")).expectNext(user).verifyComplete();
	}

	@Test
	void testGetUserById_NotFound() {
		Mockito.when(userRepo.findById("99")).thenReturn(Mono.empty());

		StepVerifier.create(userService.getUser("99"))
				.expectErrorMatches(ex -> ex instanceof NotFoundException && ex.getMessage().equals("User not found"))
				.verify();
	}

	@Test
	void testGetUserByEmail_Success() {
		User user = new User("1", "Yati", "yati@mail.com");

		Mockito.when(userRepo.findByEmail("yati@mail.com")).thenReturn(Mono.just(user));

		StepVerifier.create(userService.getUserByEmail("yati@mail.com")).expectNext(user).verifyComplete();
	}

	@Test
	void testCreateUser() {
		User user = new User(null, "Amit", "amit@mail.com");
		User saved = new User("11", "Amit", "amit@mail.com");

		Mockito.when(userRepo.save(user)).thenReturn(Mono.just(saved));

		StepVerifier.create(userService.createUser(user)).expectNext(saved).verifyComplete();
	}

	@Test
	void testDeleteUser_Success() {
		User user = new User("10", "Alex", "alex@mail.com");

		Mockito.when(userRepo.findById("10")).thenReturn(Mono.just(user));
		Mockito.when(userRepo.deleteById("10")).thenReturn(Mono.empty());

		StepVerifier.create(userService.deleteUser("10")).verifyComplete();
	}
}
