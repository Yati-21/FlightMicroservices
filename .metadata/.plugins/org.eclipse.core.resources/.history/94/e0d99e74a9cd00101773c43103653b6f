package com.flight.service.service;

import java.time.LocalDate;
import java.time.LocalDateTime;

import org.springframework.stereotype.Service;

import com.flight.service.entity.AIRPORT_CODE;
import com.flight.service.entity.Flight;
import com.flight.service.exception.BusinessException;
import com.flight.service.exception.NotFoundException;
import com.flight.service.repository.FlightRepository;

import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

@Service
public class FlightServiceReactiveImpl implements FlightService {

    private final FlightRepository flightRepo;

    public FlightServiceReactiveImpl(FlightRepository flightRepo) {
        this.flightRepo = flightRepo;
    }

    @Override
    public Mono<Flight> addFlight(Flight flight) {

        // simple validations (airline existence will be via airline-service later if needed)
        if (flight.getFromCity().equals(flight.getToCity())) {
            return Mono.error(new BusinessException("source and destination must be different"));
        }
        if (flight.getArrivalTime().isBefore(flight.getDepartureTime())) {
            return Mono.error(new BusinessException("arrival time must be after departure time"));
        }
        if (flight.getDepartureTime().isBefore(LocalDateTime.now())) {
            return Mono.error(new BusinessException("Flight departure time must be in the future"));
        }

        // initialize availableSeats = totalSeats
        flight.setAvailableSeats(flight.getTotalSeats());

        return flightRepo.save(flight);
    }

    @Override
    public Flux<Flight> searchFlights(AIRPORT_CODE from, AIRPORT_CODE to, LocalDate date) {
        return flightRepo.findByFromCityAndToCity(from, to)
                .filter(f -> f.getDepartureTime().toLocalDate().equals(date));
    }

    @Override
    public Mono<Flight> getFlightById(String flightId) {
        return flightRepo.findById(flightId)
                .switchIfEmpty(Mono.error(new NotFoundException("Flight not found")));
    }

    @Override
    public Flux<Flight> getFlightsByAirline(String airlineCode) {
        return flightRepo.findByAirlineCode(airlineCode);
    }
}
