package com.booking.service.exception;

import com.booking.service.controller.BookingController;
import com.booking.service.service.BookingService;

import org.junit.jupiter.api.Test;
import org.mockito.Mockito;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.webflux.test.autoconfigure.WebFluxTest;
import org.springframework.test.context.bean.override.mockito.MockitoBean;
import org.springframework.test.web.reactive.server.WebTestClient;

import reactor.core.publisher.Mono;

@WebFluxTest(controllers = BookingController.class)
class GlobalErrorHandlerTest {

    @Autowired
    private WebTestClient client;

    @MockitoBean
    private BookingService service;

    @Test
    void testNotFound() {
        Mockito.when(service.getTicket("X"))
                .thenReturn(Mono.error(new NotFoundException("PNR not found")));

        client.get().uri("/bookings/get/X")
                .exchange()
                .expectStatus().isNotFound();
    }

    @Test
    void testBusinessException() {
        Mockito.when(service.cancelBooking("X"))
                .thenReturn(Mono.error(new BusinessException("Cannot cancel")));

        client.delete().uri("/bookings/cancel/X")
                .exchange()
                .expectStatus().isBadRequest();
    }

    @Test
    void testUnexpectedException() {
        Mockito.when(service.getTicket("Z"))
                .thenReturn(Mono.error(new RuntimeException("Boom")));

        client.get().uri("/bookings/get/Z")
                .exchange()
                .expectStatus().is5xxServerError();
    }
}
